@page "/day01"
@rendermode InteractiveServer
@using CSharpGames.Models

<PageTitle>Day 1: The Replicator</PageTitle>

<div class="container mt-4">
    <div class="alert alert-info border-info shadow-sm" role="alert">
        <div class="d-flex align-items-center mb-2">
            <span class="badge bg-info text-dark me-3 fs-6">New in C# 9.0</span>
            <div>
                <strong>Why Records?</strong> Before 2020, ensuring data didn't change (immutability) required writing huge amounts of boilerplate code. 
                Records solved this "Boilerplate Problem" by giving us value-based equality and safe copying in a single line.
            </div>
        </div>
        
        <div class="bg-white p-3 rounded border">
            <h6 class="text-uppercase text-muted small fw-bold mb-2">Effort / Code Required (Click to Compare)</h6>
            
            <!-- Record Row -->
            <div class="row align-items-center mb-1 p-1 rounded hover-bg-light" style="cursor: pointer;" @onclick="@(() => ShowExample("record"))">
                <div class="col-2 small text-end">Record:</div>
                <div class="col-8">
                     <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" style="width: 2%"></div>
                    </div>
                </div>
                <div class="col-2 small text-success fw-bold">1 Line</div>
            </div>

            <!-- Class Row -->
            <div class="row align-items-center p-1 rounded hover-bg-light" style="cursor: pointer;" @onclick="@(() => ShowExample("class"))">
                <div class="col-2 small text-end">Class:</div>
                <div class="col-8">
                     <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-danger" style="width: 100%"></div>
                    </div>
                </div>
                <div class="col-2 small text-danger fw-bold">50+ Lines</div>
            </div>

            <!-- Code Display -->
            @if (!string.IsNullOrEmpty(SelectedExample))
            {
                <div class="mt-3 bg-light p-2 rounded border position-relative">
                    <button class="btn btn-sm btn-close position-absolute top-0 end-0 m-2" @onclick="@(() => SelectedExample = null)"></button>
                    <small class="text-muted d-block mb-1">@SelectedTitle Example:</small>
                    <pre class="mb-0 overflow-auto" style="max-height: 200px; font-size: 0.8em;"><code>@SelectedCode</code></pre>
                </div>
            }
        </div>
    </div>

    <h1 class="text-primary mb-4">Day 1: The Replicator</h1>
    
    <div class="row">
        <div class="col-md-8 offset-md-2">
            
            <!-- Instructions Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <h5 class="card-title">Concept: Records</h5>
                    <p class="card-text">
                        Records are immutable. You use <code>with</code> to create a modified copy.
                    </p>
                    <div class="alert alert-secondary py-2">
                        <code>var newBot = oldBot with { Property = Value };</code>
                    </div>
                </div>
            </div>

            <!-- Game Area -->
            <div class="card shadow">
                <div class="card-header bg-dark text-white">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fs-5">Factory Floor - Level @Level</span>
                        <span class="badge bg-light text-dark">Score: @Score</span>
                    </div>
                    <!-- Progress Bar -->
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: @(CalculateProgress())%" aria-valuenow="@(CalculateProgress())" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
                <div class="card-body">
                    <p class="text-center mb-4">
                        <strong>Mission:</strong> Build a Target droid that matches the generic Prototype, but with the specific modifications required.
                    </p>
                    
                    <div class="row text-center mb-4 align-items-end">
                        <div class="col-5">
                            <div class="p-3 border rounded bg-light">
                                <h6>Prototype</h6>
                                <DroidVisual DroidData="@Prototype" />
                                <div class="mt-2 text-muted small text-start ps-3">
                                    <div>Name: @Prototype.Name</div>
                                    <div>Model: @Prototype.Model</div>
                                    <div>Color: @Prototype.Color</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-2 align-self-center">
                            <i class="bi bi-arrow-right fs-1 text-muted"></i>
                        </div>
                        <div class="col-5">
                            <div class="p-3 border rounded bg-warning bg-opacity-10">
                                <h6>Target</h6>
                                <DroidVisual DroidData="@Target" />
                                <div class="mt-2 text-muted small text-start ps-3">
                                    <div class="@(Target.Name != Prototype.Name ? "text-danger fw-bold" : "")">Name: @Target.Name</div>
                                    <div class="@(Target.Model != Prototype.Model ? "text-danger fw-bold" : "")">Model: @Target.Model</div>
                                    <div class="@(Target.Color != Prototype.Color ? "text-danger fw-bold" : "")">Color: @Target.Color</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Command Terminal:</label>
                        <div class="input-group">
                            <span class="input-group-text font-monospace">var target = prototype</span>
                            <input @bind="UserCode" @bind:event="oninput" type="text" 
                                   class="form-control font-monospace" 
                                   placeholder=" with { ... }" 
                                   disabled="@Success" /> 
                                   
                            @if (!Success)
                            {
                                <button @onclick="BuildDroid" class="btn btn-primary">Build</button>
                            }
                            else
                            {
                                <button @onclick="NextLevel" class="btn btn-success">Next Droid &raquo;</button>
                            }
                        </div>
                         <div class="mt-2">
                            <button class="btn btn-sm btn-outline-info" @onclick="ToggleHint">Need a Hint?</button>
                            @if (ShowHint)
                            {
                                <span class="ms-2 text-muted fst-italic">Try typing: <code>@GetHint()</code></span>
                            }
                        </div>
                    </div>

                    @if (ShowResult)
                    {
                        @if (Success)
                        {
                             <div class="alert alert-success">
                                 <strong>Success!</strong> Droid verified.
                                 <hr/>
                                 <p class="mb-0 small">
                                     <i class="bi bi-lightbulb-fill text-warning me-1"></i>
                                     <strong>Lesson:</strong> You just created a <em>brand new</em> Droid record. 
                                     The original Prototype is unchanged (Immutable). 
                                     <br/>
                                     If this were a <strong>Class</strong>, we would have just "repainted" the old one!
                                 </p>
                             </div>
                        }
                        else
                        {
                            <div class="alert alert-danger">
                                <strong>Build Failed!</strong> <br/>
                                Error: @ErrorMessage
                            </div>
                        }
                    }
                </div>
            </div>

            <!-- Data Warehouse Section -->
            @if (Warehouse.Any())
            {
                <div class="card mt-4 shadow-sm">
                    <div class="card-header bg-secondary text-white">
                        <i class="bi bi-box-seam me-2"></i>Data Warehouse (@Warehouse.Count Units)
                    </div>
                    <div class="card-body bg-light">
                        <div class="d-flex flex-wrap gap-2 justify-content-center">
                            @foreach (var droid in Warehouse)
                            {
                                <div class="border rounded p-2 bg-white text-center shadow-sm" style="width: 80px; height: 90px; overflow: hidden;">
                                    <DroidVisual DroidData="@droid" Scale="0.6" />
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@code {
    // 1. Define State
    private Droid Prototype { get; set; } = new Droid("Alpha", "T-800", "Silver");
    private Droid Target { get; set; } = new Droid("Alpha", "T-800", "Red"); // Initial target
    private List<Droid> Warehouse { get; set; } = new();

    private int Level { get; set; } = 1;
    private int Score { get; set; } = 0;
    
    private string UserCode { get; set; } = "";
    private bool ShowResult { get; set; } = false;
    private bool Success { get; set; } = false;
    private bool ShowHint { get; set; } = false;
    private string ErrorMessage { get; set; } = "";

    // Pools for random generation
    private readonly string[] Colors = { "Red", "Blue", "Green", "Gold", "Purple", "Orange", "Black", "White" };
    private readonly string[] Models = { "T-800", "R2-D2", "C-3PO", "BB-8", "IG-11", "HK-47" };
    private readonly string[] Names = { "Alpha", "Beta", "Gamma", "Delta", "Omega", "Zeta" };

    private void ToggleHint() => ShowHint = !ShowHint;

    private int CalculateProgress() => (Score % 500) / 5; // Simple 0-100 progress for every 500 points

    private string GetHint()
    {
        if (Target.Color != Prototype.Color) return $"with {{ Color = \"{Target.Color}\" }}";
        if (Target.Model != Prototype.Model) return $"with {{ Model = \"{Target.Model}\" }}";
        if (Target.Name != Prototype.Name) return $"with {{ Name = \"{Target.Name}\" }}";
        return "with { ... }";
    }

    private void NextLevel()
    {
        // 1. Generate new Level
        Score += 100;
        Level++;
        SelectedExample = null; // Hide code example on new level

        Success = false;
        ShowResult = false;
        UserCode = "";
        ShowHint = false;

        // 2. Randomly decide what changes: 0=Color, 1=Model, 2=Name
        var rnd = new Random();
        var changeType = rnd.Next(0, 3);

        // Reset Prototype Base (optional, keeps it fresh)
        Prototype = new Droid(
            Names[rnd.Next(Names.Length)], 
            Models[rnd.Next(Models.Length)], 
            "Silver" // Always start silver or basic? Let's use silver for visual clarity of change
        );

        // Create Target based on Prototype but with ONE change
        switch (changeType)
        {
            case 0: // Change Color
                string newColor;
                do { newColor = Colors[rnd.Next(Colors.Length)]; } while (newColor == Prototype.Color);
                Target = Prototype with { Color = newColor };
                break;
            case 1: // Change Model
                 string newModel;
                do { newModel = Models[rnd.Next(Models.Length)]; } while (newModel == Prototype.Model);
                Target = Prototype with { Model = newModel };
                break;
            case 2: // Change Name
                 string newName;
                do { newName = Names[rnd.Next(Names.Length)]; } while (newName == Prototype.Name);
                Target = Prototype with { Name = newName };
                break;
        }
    }

    private void BuildDroid()
    {
        ShowResult = true;
        try
        {
            var code = UserCode.Trim();
            if (!code.StartsWith("with")) throw new Exception("Code must start with the 'with' keyword.");

            // Extract content inside braces
            var start = code.IndexOf('{');
            var end = code.LastIndexOf('}');
            if (start == -1 || end == -1 || end < start) throw new Exception("Syntax error: Missing braces { }.");

            var content = code.Substring(start + 1, end - start - 1).Trim();
            var parts = content.Split('=');
            if (parts.Length != 2) throw new Exception("Syntax error: assign a property like 'Color = ...'");

            var prop = parts[0].Trim();
            var valRaw = parts[1].Trim().Trim('"', '\''); 

            Droid builtDroid;

            if (prop == "Color") builtDroid = Prototype with { Color = valRaw };
            else if (prop == "Name") builtDroid = Prototype with { Name = valRaw };
            else if (prop == "Model") builtDroid = Prototype with { Model = valRaw };
            else throw new Exception($"Unknown property '{prop}'");

            if (builtDroid == Target)
            {
                Success = true;
                Warehouse.Add(builtDroid);
            }
            else
            {
                Success = false;
                ErrorMessage = $"Droid built, but specifications do not match Target.\nResult: {builtDroid}";
            }
        }
        catch (Exception ex)
        {
            Success = false;
            ErrorMessage = ex.Message;
        }
    }

    // --- Educational Content Logic ---
    private string? SelectedExample { get; set; }
    private string? SelectedTitle => SelectedExample?.ToUpper();
    private string? SelectedCode => SelectedExample switch 
    {
        "record" => "public record Droid(string Name, string Model, string Color);",
        "class" => @"// The 'Old Way' - Manually implementing value-based equality
public class Droid : IEquatable<Droid>
{
    public string Name { get; }
    public string Model { get; }
    public string Color { get; }

    public Droid(string name, string model, string color)
    {
        Name = name;
        Model = model;
        Color = color;
    }

    public override bool Equals(object? obj)
    {
        return Equals(obj as Droid);
    }

    public bool Equals(Droid? other)
    {
        return other != null &&
               Name == other.Name &&
               Model == other.Model &&
               Color == other.Color;
    }

    public override int GetHashCode()
    {
        return HashCode.Combine(Name, Model, Color);
    }

    public static bool operator ==(Droid? left, Droid? right)
    {
        return EqualityComparer<Droid>.Default.Equals(left, right);
    }

    public static bool operator !=(Droid? left, Droid? right)
    {
        return !(left == right);
    }
    
    public override string ToString()
    {
        return $""Droid {{ Name = {Name}, Model = {Model}, Color = {Color} }}"";
    }
    
    // Check Copying? That's another method to write manually!
    public Droid With(string? name = null, string? model = null, string? color = null) 
    {
        return new Droid(name ?? Name, model ?? Model, color ?? Color);
    }
}",
        _ => null
    };

    private void ShowExample(string type) => SelectedExample = type;
}
